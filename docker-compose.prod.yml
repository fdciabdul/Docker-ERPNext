version: '3.8'

services:
  backend:
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  worker:
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  worker-short:
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  worker-long:
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 1G

  db:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed
      - --max-connections=500
      - --innodb-buffer-pool-size=1G
      - --innodb-log-file-size=256M

  redis-cache:
    command:
      - redis-server
      - --maxmemory
      - 512mb
      - --maxmemory-policy
      - allkeys-lru

  frontend:
    environment:
      PROXY_READ_TIMEOUT: 300
      CLIENT_MAX_BODY_SIZE: 100m
